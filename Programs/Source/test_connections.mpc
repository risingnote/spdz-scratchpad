"""
Test receiving and sending external client inputs with updated SPDZ instructions / SPDZ Proxy.
"""

from Compiler.types import sint, regint, ClientMessageType
from Compiler.instructions import listen, acceptclientconnection
from Compiler.library import do_while, print_ln

PORTNUM = 14000

def main():

    listen(PORTNUM)
    print_ln('Listening for client connections on base port %s', PORTNUM)

    @do_while
    def read_input_from_client_loop():
        client_socket_id = regint()
        acceptclientconnection(client_socket_id, PORTNUM)
        regint.read_client_public_key(client_socket_id)

        input_list = sint.receive_from_client(1, client_socket_id, ClientMessageType.InputTriple)

        print_ln('Received input %s', input_list[0].reveal())

        results = Array(1, cint)
        results[0] = (input_list[0] * 2).reveal()

        # results = Array(1, regint)
        # results[0] = sint(23).reveal() # implicit type conversion cint -> regint

        print_ln('About to send result %s', results[0])

        cint.write_to_socket(client_socket_id, results, ClientMessageType.OutputResult, True)
        # regint.write_to_socket(client_socket_id, results, ClientMessageType.OutputResult, True)

        return 1

main()
